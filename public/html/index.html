<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="css/element-ui.css">
  <style>
    html,
    body,
    p {
      padding: 0;
      margin: 0;
    }

    .title {
      font-size: 24px;
      font-weight: 500;
      text-align: center;
    }

    /* 使用说明 */
    .instruction {
      padding-left: 20px;
      margin-bottom: 20px;
    }

    .instruction p {
      font-size: 14px;
      line-height: 2;
      color: #666;
    }

    .result-wrap .item {
      display: inline-block;
      width: 200px;
      margin-right: 20px;
    }

    .main-wrap {
      margin-top: 30px;
      padding: 0px 20px;
    }

    .result-wrap {
      position: relative;
      min-height: 200px;
      padding: 20px 10px;
      overflow-y: auto;
      border: 1px solid #ddd;
    }

    .result-wrap .label {
      width: 200px;
      margin-bottom: 15px;
      padding: 0 10px;
      line-height: 1.5;
      box-sizing: border-box;
      border: 1px solid #f00;
    }

    .result-wrap .label.success {
      border: 1px solid #0f0;
    }

    .percent {
      position: absolute;
      bottom: 5px;
      right: 10px;
    }

    .file-input {
      position: relative;
      overflow: hidden;
      height: 40px;
      line-height: 40px;
      border: 1px solid #ddd;
    }

    .file-input label {
      position: absolute;
      top: 0px;
      left: 0px;
      display: inline-block;
      width: 100%;
      height: 100%;
      padding: 0 15px;
      cursor: pointer;
    }

    .file-input label .gray {
      color: #999;
    }

    #file-input {
      position: absolute;
      margin-left: -9999px;
      z-index: -1;
      opacity: 0;
    }
  </style>
</head>

<body>

  <div id="app" class="main-wrap">
    <h2 class="title">自动升级</h2>
    <div class="instruction">
      注意事项：
      <p>1. 当所传固件包不符合升级要求时会导致设备固件升级失败，最终固件版本请在设备上确认</p>
      <p>2. 升级过程中请不要关闭或刷新页面</p>
      <p>3. 升级结果中设备IP顺序和输入IP顺序不一定一致，此情况不影响升级功能</p>
      <p>4. 升级过程中失败的设备会进行多次尝试升级，多设备升级时时间会较长，请耐心等待！</p>
    </div>
    <!-- inject content -->
    <!-- 
      1. 设备IP、固件包、升级结果
      2. 要求：
        1. 支持多设备固件自动上传升级
        2. 升级失败自动重新尝试
        3. 设置自动尝试事件间隔
     -->
    <el-form ref="upgradeForm" label-position="left" label-width="80px" :rules="rules" :model="upgradeForm">
      <el-form-item label="设备IP" prop="ip">
        <el-input placeholder="请输入设备IP(多个IP用逗号隔开)" type="textarea" rows="5" v-model.trim="upgradeForm.ip"></el-input>
      </el-form-item>
      <el-form-item label="固件包" prop="file">
        <div class="file-input">
          <label for="file-input" v-text="">
            <span
              :class="{ gray: !(upgradeForm.file && upgradeForm.file.name) }"
              v-text="upgradeForm.file && upgradeForm.file.name || '请选择固件包'">
            </span>
          </label>
          <el-input v-show="false" v-model="upgradeForm.file"></el-input>
          <input ref="fileInput" @change="handleFileChange" id="file-input" type="file">
        </div>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" :disabled="upgrading" @click="submit" v-text="'升 级' + (upgrading ? ' 中...' : '')">
        </el-button>
      </el-form-item>
      <el-form-item label="升级结果">
        <div class="result-wrap">
          <p class="percent" style="color:#666;">
            <span style="color: #0f0" v-text="resultObj.list.length"></span>/
            <span v-text="resultObj.total"></span>
          </p>
          <div
            v-for="(item, index) in resultObj.list"
            :key="index" :class="{success: item.success}" 
            class="label"
            v-text="item.ip">
            <span v-text="item.ip"></span>
            <span v-show="item.version" v-text="`(${item.version})`"></span>
          </div>
        </div>
      </el-form-item>l
    </el-form>
  </div>


  <script src="./js/jquery-1.12.4.min.js"></script>
  <script src="./js/vue.js"></script>
  <script src="./js/element-ui.js"></script>
  <script>
    var ipRep = /^([\d]|[1-9][\d]|1[\d]{2}|2[0-4][\d]|25[0-5])(\.([\d]|[1-9][\d]|1[\d]{2}|2[0-4][\d]|25[0-5])){3}$/

    // 校验并格式化IP，并将其分组
    /*
    * @return {success} Boolean 当前IP是否已经升级成功
    * @return {count} Number 已升级次数, 
    * 用于限制自动重新升级次数限制
    */

    function formatIps(ips) {
      ips = (ips || '').replace(/\s/g, '').split(',').filter(function (item) {
        return !!item
      })
      var arr = []
      // 对象保存键值，进行数组去重
      var map = {}
      for (var i = 0; i < ips.length; i++) {
        if (ips[i] && !map[ips[i]]) {
          arr.push({
            ip: ips[i],
            success: false,
            count: ipRep.test(ips[i]) ? 0 : -1
          })
          map[ips[i]] = true
        }
      }
      return arr
    }

    window.onload = function () {
      // 规则： 多个IP用英文逗号隔开，每个IP 格式必须合法
      var ipValidator = function (rule, value, cb) {
        if (value && formatIps(value).length) {
          cb()
        } else {
          cb(new Error('请输入设备IP'))
        }
      }

      var fileValidator = function (rule, value, cb) {
        if (value) {
          cb()
        } else {
          cb(new Error('请选取固件包'))
        }
      }

      var _vm = new Vue({
        el: '#app',
        data: function () {
          return {
            upgradeForm: {
              ip: '',
              file: ''
            },
            rules: {
              ip: [
                { required: true, validator: ipValidator, trigger: 'blur' }
              ],
              file: [
                { required: true, validator: fileValidator, trigger: 'blur' }
              ]
            },
            uploadRequest: null, // 当前上传请求，为了处理上传请求无响应来取消请求的
            upgrading: false, // 是否正在升级中
            checking: false, // 批量版本校验
            current: { // 当前上传对象
              ip: '',
              index: 0
            },
            percent: 0,
            percentSame: 0, // 上传进度连续无变化次数
            maxCount: 10, // 限制单个IP升级次数上限
            sleep: 40, // 同一IP连续升级间隔时间
            resultObj: {
              total: 0,
              list: []
            },
            ipList: [] // 待升级的IP List
          }
        },
        mounted() {
        },
        computed: {
          baseUrl() {
            return 'http://' + this.current.ip + ':8090'
          },
          // 固件包版本
          zipVersion() {
            var name = (this.upgradeForm.file || {}).name || ''
            return name.split('_')[3] || ''
          }
        },
        methods: {
          initData () {
            this.resetData()
            var ips = formatIps(this.upgradeForm.ip)
            this.filterIp(ips)
            this.resultObj.list = ips.filter(function (i) {
              return i.success || i.count === -1
            })
            this.resultObj.total = ips.length
          },
          // 过滤需要重新升级的IP列表
          filterIp(list) {
            this.ipList = (list || this.ipList).filter(function (item) {
              return !item.success && item.count > -1
            })
          },
          submit() {
            if (this.checking) {
              return this.$message.warn('版本检验正在处理中，请稍后！')
            }
            var _this = this
            this.$refs.upgradeForm.validate(function (valid) {
              if (valid) {
                _this.initData()
                if (!_this.resultObj.total) {
                  return _this.$message.warn('请输入有效设备IP')
                }
                _this.upgrading = true
                _this.handleUpgrade()
              }
            })
          },
          // 文件格式校验
          handleFileChange(event) {
            e = event || window.event
            var file = e.target.files[0]
            this.upgradeForm.file = file
            var type = file
              && file.name 
              && file.name.substring(file.name.lastIndexOf('.') + 1)
            if (file && type !== 'zip') {
              this.$message.error('只支持zip文件格式')
              this.$refs.fileInput.value = ''
              this.upgradeForm.file = ''
            }
          },
          // 获取设备应用版本，判定如何升级
          getVersion(index) {
            var _this = this
            request({
              url: '/getdevices',
              baseUrl: _this.baseUrl
            }).then(function (res) {
              if (res.data && res.data.version === _this.zipVersion) {
                _this.updateState(_this.current.index, true)
                _this.handleUpgrade(_this.current.index++)
              } else {
                _this.uploadFile(_this.current.index)
              }
            }).catch(function (error) {
              console.error('version', error)
              // 版本信息接口无法正常获取,将视为此IP不存在，不再尝试
              _this.updateState(_this.current.index)
              _this.handleUpgrade(_this.current.index++)
            })
          },
          // 固件上传
          uploadFile() {
            var _this = this
            // request({
            //   url: '/devicestate',
            //   baseUrl: _this.baseUrl
            // }).then(function (res) {
            var formData = new FormData()
            var file = _this.upgradeForm.file
            formData.append('file', file, file.name)
            this.uploadRequest = $.ajax({
              type: 'post',
              url: _this.baseUrl + '/uploadFile',
              processData: false, // 使数据不做处理
              contentType: false, // 不要设置Content-Type请求头
              data: formData,
              success: function (res) {
                var data = JSON.parse(res)
                if (data.success) {
                  _this.updateState(_this.current.index, true)
                } else {
                  _this.updateState(_this.current.index, 'count')
                }
                _this.handleUpgrade(_this.current.index++)
              },
              error: function () {
                _this.updateState(_this.current.index, 'count')
                _this.handleUpgrade(_this.current.index++)
              }
            })

            setTimeout(function () {
              _this.getPercent()
            }, 2000)
            // }).catch(function (error, xhr) {
            //   console.error(error, xhr)
            //   _this.updateState(_this.current.index, 'count')
            //   _this.handleUpgrade(_this.current.index++)
            // })
          },
          // 升级
          handleUpgrade(index) {
            var _this = this
            index = index || this.current.index || 0
            if (!this.ipList.length) {
              this.$message.success('升级完成')
              this.upgrading = false
              return
            }
            // index > length - 1 视为数组遍历完一次
            if (index > this.ipList.length - 1) {
              this.current.index = 0
              this.filterIp()
            }
            if (!this.ipList[this.current.index]) {
              return this.handleUpgrade(this.current.index++)
            }
            // 当前设备/IP 信息
            const cd = this.ipList[this.current.index]
            const now = new Date().getTime()
            // 如果lastTime属性存在则视为再次尝试, 
            // 重新尝试升级须与上一次升级间隔一定时间
            const sleepTime = (now - (cd.lastTime || 0)
              < _this.sleep * 1000)
              ? _this.sleep * 1000
              : 0
            setTimeout(function () {
              _this.current.ip = cd.ip
              _this.getVersion(index)
            }, sleepTime)


          },
          // 获取上传进度
          getPercent() {
            var _this = this
            request({
              url: '/percent',
              baseUrl: _this.baseUrl
            }).then(function (res) {
              if (res.data >= 100 || this.data === '100%') {
                _this.updateState(_this.current.index, true)
                _this.handleUpgrade(_this.current.index++)
                _this.abortUpload()
              } else if (res.data !== '0%' && _this.percentSame <= 5 && _this.ipList[_this.current.index]) {
                if (_this.percent === res.data) {
                  _this.percentSame++
                } else {
                  _this.percentSame = 0
                }
                setTimeout(function () {
                  _this.getPercent()
                }, 1500)
              } else {
                _this.updateState(_this.current.index, 'count')
                _this.handleUpgrade(_this.current.index++)
                _this.abortUpload()
              }
              _this.percent = res.data
            }).catch(function (error) {
              console.error(error)
              _this.updateState(_this.current.index, 'count')
              _this.handleUpgrade(_this.current.index++)
              _this.abortUpload()
            })
          },
          // 更新状态
          updateState(index, state) {
            this.percentSame = 0
            this.percent = 0
            // 当前升级IP 信息
            var item = this.ipList[index > this.ipList.length - 1 ? this.ipList.length - 1 : index]
            var newItem
            if (!item) return
            // 限制单个IP升级次数上限
            if (item.count >= this.maxCount || !state) {
              newItem = Object.assign(item, { count: -1 })
              this.resultObj.list.push(newItem)
            } else if (state === true) { // 升级成功数组状态更新
              newItem = Object.assign(item, { success: true })
              this.resultObj.list.push(newItem)
            } else if (state === 'count') {
              newItem = Object.assign(
                item,
                {
                  count: ++item.count,
                  lastTime: new Date().getTime()
                }
              )
            }
            this.ipList.splice(index, 1, newItem)
          },
          // 重置数据
          resetData() {
            this.current = {
              ip: '',
              index: 0
            }
            this.resultObj = {
              total: 0,
              list: []
            }
            this.ipList = []
          },

          //  取消上传，通过获取进度接口得到上传完成时，主动断开上传请求
          abortUpload() {
            if (this.uploadRequest) {
              this.uploadRequest.abort()
              this.uploadRequest = null
            }
          },
          // 批量校验版本信息
          batchCheckVersion (index) {
            var _this = this
            index = index || this.current.index || 0
            if (index > this.ipList.length - 1) {
              this.$message.success('版本校验完成！')
              this.checking = false
              return
            }
            var present = this.ipList[this.current.index]
            this.current.ip = present.ip
            request({
              url: '/getdevices',
              baseUrl: _this.baseUrl
            }).then(function (res) {
              if (res.data.version === _this.zipVersion) {
                _this.resultObj.list.push(
                  Object.assign(present, { success: true })
                )
              } else {
                _this.resultObj.list.push(
                  Object.assign(present, { version: res.data.version })
                )
              }
              _this.batchCheckVersion(_this.current.index++)
            }).catch(function (error) {
              _this.resultObj.list.push(
                Object.assign(present, { version: '获取版本信息失败' })
              )
              _this.batchCheckVersion(_this.current.index++)
            })
          },
          // 校验版本
          handleCheck () {
            if (this.upgrading) {
              return this.$message.warn('升级正在处理中，请稍后！')
            }
            var _this = this
            this.$refs.upgradeForm.validate(function (valid) {
              if (valid) {
                _this.initData()
                if (!_this.resultObj.total) {
                  return _this.$message.warn('请输入有效设备IP')
                }
                _this.checking = true
                _this.batchCheckVersion()
              }
            })
          }
        }
      })
    }

    function isFunction(val) {
      return typeof val === 'function'
    }

    // 统一 ajax 请求
    function request(params) {
      // 参数存在 并且非上传接口时 将data转换JSON.stringify
      return new Promise(function (resolve, reject) {
        if (params.data && params.type &&
          params.type !== 'get' &&
          params.contentType !== 'application/form-data') {
          params.data = JSON.stringify(params.data)
        }

        var baseParams = {
          type: 'post',
          baseUrl: '',
          url: '',
          success: function (res, status, xhr) {
            var data = JSON.parse(res)
            if (data.success) {
              resolve(data)
            } else {
              reject(data, xhr, status)
            }
          },
          error: function (xhr, status, error) {
            console.error(error)
            reject(error, xhr, status)
          }
        }

        params.url = (params.baseUrl || baseParams.baseUrl) + params.url

        return $.ajax(Object.assign(baseParams, params))
      })

    }
  </script>
</body>

</html>